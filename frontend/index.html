<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wellbeing Planner</title>
  <style>
    :root {
      color-scheme: only light;
      --bg: #f8f5ff;
      --card: #ffffff;
      --border: #dcd6f2;
      --accent: #8d0af7;
      --accent-dark: #6f08c5;
      --text: #292d33;
      --muted: #60636b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 24px;
      background: linear-gradient(135deg, #8d0af7, #c37dff);
      color: #ffffff;
    }
    .header-inner {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .logo {
      width: 54px;
      height: 54px;
      object-fit: contain;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #ffffff;
    }
    header p {
      margin: 6px 0 0;
      max-width: 720px;
      line-height: 1.5;
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.85);
    }
    main {
      width: min(1100px, 94%);
      margin: 28px auto 48px;
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 22px 24px;
      border: 1px solid var(--border);
      box-shadow: 0 14px 24px -18px rgba(15,23,42,0.35);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    h2 {
      margin: 0;
      font-size: 1.2rem;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font: inherit;
      background: #fff;
      color: var(--text);
      resize: vertical;
      min-height: 44px;
    }
    textarea {
      min-height: 120px;
    }
    .inline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }
    button {
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: var(--accent-dark);
    }
    .output-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .output-group {
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }
    .output-group:first-child {
      border-top: none;
      padding-top: 0;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent-dark);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-right: 6px;
    }
    .plan-item {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 12px;
      background: rgba(59, 130, 246, 0.03);
    }
    .calendar-item, .candidate-item {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 0.92rem;
    }
    .error {
      background: rgba(220, 38, 38, 0.1);
      color: #b91c1c;
      border: 1px solid rgba(220, 38, 38, 0.3);
      border-radius: 12px;
      padding: 12px 16px;
    }
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 0.95rem;
    }
    #lqi-chart svg {
      width: 100%;
      height: 140px;
    }
    footer {
      text-align: center;
      padding: 28px 0 36px;
      font-size: 0.85rem;
      color: var(--muted);
    }
    @media (max-width: 640px) {
      header {
        padding: 20px;
      }
      main {
        width: calc(100% - 32px);
        margin: 24px auto 36px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <img src="/assets/syd_logo.png" alt="Wellbeing planner logo" class="logo" />
      <div>
        <h1>Wellbeing Planner</h1>
        <p>Enter a quick snapshot of how you&rsquo;re doing and the planner will craft an empathetic reply, evidence-backed micro-actions, and a Life Quality Signal to help you track momentum.</p>
      </div>
    </div>
  </header>
  <main>
    <section class="card">
      <h2>Share Today&rsquo;s Context</h2>
      <form id="plan-form">
        <div class="inline">
          <label> User ID
            <input type="text" id="userId" value="demo-user" required />
          </label>
          <label> Available Minutes
            <input type="number" id="minutes" min="1" max="480" value="20" required />
          </label>
        </div>
        <label> Mood (optional)
          <input type="text" id="mood" placeholder="e.g. A bit tense but hopeful" />
        </label>
        <div class="inline">
          <label> Focus Area
            <input type="text" id="focusArea" placeholder="stress, focus, sleep..." value="stress" />
          </label>
          <label> Timezone
            <input type="text" id="timezone" value="UTC" />
          </label>
        </div>
        <label> Preferences (comma separated)
          <input type="text" id="preferences" placeholder="gentle, at-desk" value="gentle, at-desk" />
        </label>
        <label> Conversation Snippets (each line becomes a turn)
          <textarea id="messages">Having a heavy week and sleep has been rough.
Need something gentle I can do between meetings.
Lower back feels tight from sitting.</textarea>
        </label>
        <button type="submit">Generate Personalized Plan</button>
        <span class="loading" id="loading" hidden>
          <span class="spinner">⏳</span>
          Working on your plan...
        </span>
        <div id="error" class="error" hidden></div>
      </form>
    </section>
    <section class="card">
      <h2>Results</h2>
      <div class="output-section" id="results">
        <p>Submit the form to see your plan, evidence, and Life Quality Signal.</p>
      </div>
    </section>
  </main>
  <footer>
    Built with care · Privacy-aware · Evidence-backed
  </footer>

  <script>
    const form = document.getElementById('plan-form');
    const resultsEl = document.getElementById('results');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      errorEl.hidden = true;
      resultsEl.innerHTML = '';
      loadingEl.hidden = false;

      try {
        const payload = buildPayload();
        const response = await fetch('/plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }
        const data = await response.json();
        renderResults(data);
        drawLifeQualityChart(payload.context.user_id);
      } catch (err) {
        console.error(err);
        errorEl.textContent = err.message || 'Unexpected error generating plan.';
        errorEl.hidden = false;
        resultsEl.innerHTML = '';
      } finally {
        loadingEl.hidden = true;
      }
    });

    function buildPayload() {
      const userId = document.getElementById('userId').value.trim();
      const minutes = parseInt(document.getElementById('minutes').value, 10);
      const mood = document.getElementById('mood').value.trim();
      const focusArea = document.getElementById('focusArea').value.trim();
      const timezone = document.getElementById('timezone').value.trim();
      const prefsRaw = document.getElementById('preferences').value;
      const messagesRaw = document.getElementById('messages').value;

      const preferences = prefsRaw
        .split(',')
        .map((p) => p.trim())
        .filter(Boolean);
      const messages = messagesRaw
        .split('\n')
        .map((line) => line.trim())
        .filter(Boolean)
        .map((content) => ({ role: 'user', content }));

      if (messages.length === 0) {
        throw new Error('Please provide at least one message.');
      }

      return {
        context: {
          user_id: userId || `anon-${Date.now()}`,
          available_minutes: Number.isFinite(minutes) ? minutes : 15,
          mood: mood || null,
          focus_area: focusArea || null,
          preferences: preferences.length ? preferences : null,
          timezone: timezone || 'UTC',
        },
        conversation: { messages },
      };
    }

    function renderResults(data) {
      const sections = [];

      sections.push(createEmpathySection(data));
      sections.push(createSignalsSection(data));
      sections.push(createPlanSection(data));
      sections.push(createCalendarSection(data));
      sections.push(createExplanationsSection(data));
      sections.push(createLifeQualitySection(data));

      if (data.personalized_nudge) {
        sections.push(createNudgeSection(data.personalized_nudge));
      }

      resultsEl.replaceChildren(...sections);
    }

    function createSection(title, contentNodes = []) {
      const wrapper = document.createElement('div');
      wrapper.className = 'output-group';
      const heading = document.createElement('h3');
      heading.textContent = title;
      heading.style.margin = '0 0 8px 0';
      wrapper.appendChild(heading);
      contentNodes.forEach(node => wrapper.appendChild(node));
      return wrapper;
    }

    function createEmpathySection(data) {
      const para = document.createElement('p');
      para.textContent = data.empathetic_message || '—';
      return createSection('Empathetic Response', [para]);
    }

    function createSignalsSection(data) {
      const { signals } = data;
      if (!signals) return createSection('Signals', [document.createTextNode('Unavailable')]);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div><strong>Sentiment:</strong> ${signals.sentiment.toFixed(2)} (model: ${signals.sentiment_model}, conf: ${signals.sentiment_confidence.toFixed(2)})</div>
        <div><strong>Calibrated:</strong> ${signals.sentiment_calibrated.toFixed(2)}</div>
        <div><strong>Energy:</strong> ${signals.energy_level}</div>
        <div><strong>Themes:</strong> ${signals.top_themes.map(t => `<span class="tag">${t}</span>`).join(' ') || '—'}</div>
        <div style="margin-top:6px;color:var(--muted);">${signals.summary}</div>
      `;
      return createSection('Reflection Signals', [wrapper]);
    }

    function createPlanSection(data) {
      const itemsContainer = document.createElement('div');
      (data.plan?.items || []).forEach(item => {
        const div = document.createElement('div');
        div.className = 'plan-item';
        div.innerHTML = `
          <div style="font-weight:600;font-size:1.05rem;">${item.title}</div>
          <div style="margin:4px 0;">${item.why_it_helps}</div>
          <div style="color:var(--muted);font-size:0.9rem;margin-bottom:6px;">${item.instructions}</div>
          <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--muted);">
            <span>Duration: ${item.duration_minutes} min</span>
            <span>Citation: ${item.evidence_citation || 'n/a'}</span>
          </div>
        `;
        itemsContainer.appendChild(div);
      });
      if (data.plan?.caution) {
        const caution = document.createElement('div');
        caution.className = 'error';
        caution.textContent = data.plan.caution;
        itemsContainer.appendChild(caution);
      }
      return createSection('Recommended Actions', [itemsContainer]);
    }

    function createCalendarSection(data) {
      const blocks = data.calendar_blocks || [];
      if (!blocks.length) {
        return createSection('Calendar Blocks', [document.createTextNode('No blocks suggested.')]);
      }
      const container = document.createElement('div');
      blocks.forEach(block => {
        const div = document.createElement('div');
        div.className = 'calendar-item';
        div.innerHTML = `<strong>${block.label}</strong><br/>${new Date(block.start_iso).toLocaleString()} → ${new Date(block.end_iso).toLocaleTimeString()} (${block.timezone})`;
        container.appendChild(div);
      });
      return createSection('Calendar Blocks', [container]);
    }

    function createExplanationsSection(data) {
      const explanations = data.explanations || [];
      if (!explanations.length) {
        return createSection('Evidence & Citations', [document.createTextNode('No citations available.')]);
      }
      const container = document.createElement('div');
      explanations.forEach(exp => {
        const div = document.createElement('div');
        div.className = 'candidate-item';
        div.innerHTML = `<strong>${exp.content_id}</strong> · ${exp.citation}<br/>${exp.snippet}`;
        container.appendChild(div);
      });
      return createSection('Evidence & Citations', [container]);
    }

    function createLifeQualitySection(data) {
      const lqi = data.life_quality;
      if (!lqi) {
        return createSection('Life Quality Signal', [document.createTextNode('Not available.')]);
      }
      const container = document.createElement('div');
      container.innerHTML = `
        <div style="font-size:1.4rem;font-weight:700;">${lqi.score.toFixed(1)} / 100</div>
        <div style="color:var(--muted);">Trend: ${lqi.trend || 'steady'}</div>
      `;
      const chart = document.createElement('div');
      chart.id = 'lqi-chart';
      container.appendChild(chart);
      const recentList = document.createElement('div');
      recentList.style.fontSize = '0.85rem';
      recentList.style.color = 'var(--muted)';
      recentList.style.marginTop = '6px';
      recentList.textContent = `${lqi.recent.length} recent checkpoints stored.`;
      container.appendChild(recentList);
      return createSection('Life Quality Signal', [container]);
    }

    function createNudgeSection(message) {
      const div = document.createElement('div');
      div.className = 'candidate-item';
      div.style.background = 'rgba(34,197,94,0.08)';
      div.style.borderColor = 'rgba(34,197,94,0.2)';
      div.innerHTML = `<strong>Personalized Nudge</strong><br/>${message}`;
      return createSection('Motivational Nudge', [div]);
    }

    async function drawLifeQualityChart(userId) {
      const target = document.getElementById('lqi-chart');
      if (!target) return;
      target.innerHTML = '';
      try {
        const resp = await fetch(`/metrics/life-quality?user_id=${encodeURIComponent(userId)}&limit=30`);
        if (!resp.ok) throw new Error('Unable to fetch life quality history');
        const data = await resp.json();
        const points = data.points || [];
        target.appendChild(createSparkline(points));
      } catch (err) {
        console.warn('Life quality chart error:', err);
        target.textContent = 'No history available yet.';
      }
    }

    function createSparkline(points) {
      const width = 320;
      const height = 120;
      const padding = 18;
      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      svg.style.background = 'rgba(37, 99, 235, 0.05)';
      svg.style.borderRadius = '12px';

      if (!points.length) {
        const text = document.createElementNS(svgNS, 'text');
        text.setAttribute('x', width / 2);
        text.setAttribute('y', height / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'var(--muted)');
        text.textContent = 'No history yet';
        svg.appendChild(text);
        return svg;
      }

      const xs = points.map((_, idx) => idx);
      const ys = points.map((p) => Number(p.score));
      const minY = Math.min(...ys, 0);
      const maxY = Math.max(...ys, 100);
      const span = Math.max(maxY - minY, 1);
      const stepX = (width - padding * 2) / Math.max(points.length - 1, 1);

      const polylinePoints = points.map((p, idx) => {
        const x = padding + stepX * idx;
        const normalized = 1 - ((Number(p.score) - minY) / span);
        const y = padding + normalized * (height - padding * 2);
        return `${x},${y}`;
      }).join(' ');

      const area = document.createElementNS(svgNS, 'polygon');
      area.setAttribute('points', `${padding},${height - padding} ${polylinePoints} ${(width - padding)},${height - padding}`);
      area.setAttribute('fill', 'rgba(59, 130, 246, 0.22)');
      svg.appendChild(area);

      const polyline = document.createElementNS(svgNS, 'polyline');
      polyline.setAttribute('points', polylinePoints);
      polyline.setAttribute('fill', 'none');
      polyline.setAttribute('stroke', '#2563eb');
      polyline.setAttribute('stroke-width', '3');
      svg.appendChild(polyline);

      points.forEach((p, idx) => {
        const x = padding + stepX * idx;
        const normalized = 1 - ((Number(p.score) - minY) / span);
        const y = padding + normalized * (height - padding * 2);
        const circle = document.createElementNS(svgNS, 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 4.5);
        circle.setAttribute('fill', '#1d4ed8');
        svg.appendChild(circle);
      });

      return svg;
    }
  </script>
</body>
</html>
